---
import { Image } from 'astro:assets';
import { getLQIPInfo } from '../utils/lqip/astro-lqip';

export interface Props {
  src: string | { src: string; [key: string]: unknown };
  alt: string;
  slug?: string;
  width?: number;
  height?: number;
  widths?: number[];
  sizes?: string;
  quality?: number;
  format?: 'webp' | 'avif' | 'png' | 'jpg';
  full?: boolean; // 풀사이즈 표시 여부
}

const { 
  src, 
  alt, 
  width = 800, 
  height,
  quality = 80,
  format = 'webp',
  full = false // 기본값은 80% 크기
} = Astro.props;

// 고유한 이미지 ID 생성
const imageId = `img-${Math.random().toString(36).substr(2, 9)}`;

// 기기별 최적화된 반응형 이미지 설정 (더 세밀한 크기 조정)
const responsiveConfig = full ? {
  // 풀사이즈 (100%) - 큰 이미지들
  widths: [480, 768, 1024, 1280, 1536],
  sizes: "(max-width: 480px) 100vw, (max-width: 768px) 100vw, (max-width: 1024px) 1024px, 1280px"
} : {
  // 컴팩트 크기 (80%) - 작은 이미지들  
  widths: [320, 480, 640, 768, 960],
  sizes: "(max-width: 480px) 95vw, (max-width: 768px) 80vw, (max-width: 1024px) 640px, 640px"
};

const { widths, sizes } = responsiveConfig;

// URL에서 slug 추출
const urlPath = Astro.url.pathname;
const slugMatch = urlPath.match(/\/blog\/([^/]+)/);
const detectedSlug = slugMatch ? slugMatch[1] : undefined;
const finalSlug = Astro.props.slug || detectedSlug;

// src가 객체인지 문자열인지 확인하고 적절한 값 추출
const imageSrc = typeof src === "object" ? src.src : src;

// 블로그 포스트의 첫 번째 이미지 판단 (간단한 휴리스틱)
const isBlogPost = urlPath.includes('/blog/') && !urlPath.endsWith('/blog/');
// 블로그 포스트에서 상대 경로로 시작하거나 assets 폴더의 이미지는 LCP 후보로 간주
const isLikelyFirstImage = isBlogPost && (
  imageSrc.startsWith('./') || 
  imageSrc.includes('@assets/images/') ||
  imageSrc.includes('assets/images/')
);

// 모든 이미지들을 동적으로 import (content/blog + assets/images)
const images = import.meta.glob([
  '/src/content/blog/**/*.{jpg,jpeg,png,webp,gif,svg}',
  '/src/assets/images/**/*.{jpg,jpeg,png,webp,gif,svg}'
], { eager: false });

// 이미지 경로 정규화 및 dynamic import 처리
let processedImageSrc = imageSrc;
let useAstroImage = false;

// 더 적극적인 이미지 감지 로직 - 직접 파일명 참조 우선 처리
if (finalSlug && imageSrc) {
  let absolutePath = '';
  let fallbackPaths: string[] = [];
  
  // 이미 Astro가 처리한 /_astro/ 경로인 경우 역추적
  if (imageSrc.startsWith('/_astro/')) {
    // /_astro/blog-written-by-ai.7p_-XgL_.webp -> blog-written-by-ai.webp
    const astroFileName = imageSrc.split('/').pop(); // "blog-written-by-ai.7p_-XgL_.webp"
    if (astroFileName) {
      // 해시 부분 제거: "blog-written-by-ai.7p_-XgL_.webp" -> "blog-written-by-ai.webp"
      // Astro 해시 패턴: filename.hash_more.ext
      const originalFileName = astroFileName.replace(/\.[a-zA-Z0-9_-]+_[a-zA-Z0-9_-]*\./g, '.');
      
      console.log(`🔄 /_astro/ 경로 역추적: ${astroFileName} -> ${originalFileName}`);
      
      // 역추적된 파일명으로 다시 시도
      absolutePath = `/src/content/blog/${finalSlug}/${originalFileName}`;
      fallbackPaths = [
        `/src/content/blog/${finalSlug}/${originalFileName.replace(/\.(jpg|jpeg|png|gif|svg)$/i, '.webp')}`,
        `/src/content/blog/${finalSlug}/${originalFileName.replace(/\.(webp|jpg|jpeg|png|gif|svg)$/i, '.png')}`,
        `/src/content/blog/${finalSlug}/${originalFileName.replace(/\.(webp|jpg|jpeg|png|gif|svg)$/i, '.jpg')}`,
        `/src/assets/images/${finalSlug}/${originalFileName}`,
        `/src/assets/images/${originalFileName}`,
      ];
    }
  }
  // 직접 파일명만 있는 경우를 최우선으로 처리 (blog-written-by-ai.webp)
  else if (!imageSrc.includes('/') && !imageSrc.startsWith('http') && !imageSrc.startsWith('@')) {
    // 1순위: 해당 블로그 폴더 내 직접 파일
    absolutePath = `/src/content/blog/${finalSlug}/${imageSrc}`;
    fallbackPaths = [
      // 2순위: webp 확장자 변경
      `/src/content/blog/${finalSlug}/${imageSrc.replace(/\.(jpg|jpeg|png|gif|svg)$/i, '.webp')}`,
      // 3순위: 다른 확장자들
      `/src/content/blog/${finalSlug}/${imageSrc.replace(/\.(webp|jpg|jpeg|png|gif|svg)$/i, '.jpg')}`,
      `/src/content/blog/${finalSlug}/${imageSrc.replace(/\.(webp|jpg|jpeg|png|gif|svg)$/i, '.png')}`,
      // 4순위: assets 폴더
      `/src/assets/images/${finalSlug}/${imageSrc}`,
      `/src/assets/images/${imageSrc}`,
    ];
  }
  // 상대 경로 처리 (./image.jpg)
  else if (imageSrc.startsWith('./')) {
    const cleanSrc = imageSrc.replace('./', '');
    absolutePath = `/src/content/blog/${finalSlug}/${cleanSrc}`;
    fallbackPaths = [
      `/src/content/blog/${finalSlug}/${cleanSrc.replace(/\.(jpg|jpeg|png|gif|svg)$/i, '.webp')}`,
      `/src/assets/images/${finalSlug}/${cleanSrc}`,
    ];
  }
  // @assets 경로 처리
  else if (imageSrc.includes('@assets/images/')) {
    const cleanSrc = imageSrc.replace('@assets/images/', '');
    absolutePath = `/src/assets/images/${cleanSrc}`;
    fallbackPaths = [
      `/src/assets/images/${cleanSrc.replace(/\.(jpg|jpeg|png|gif|svg)$/i, '.webp')}`,
    ];
  }
  // assets/ 직접 경로
  else if (imageSrc.startsWith('assets/images/')) {
    absolutePath = `/src/${imageSrc}`;
    fallbackPaths = [
      `/src/${imageSrc.replace(/\.(jpg|jpeg|png|gif|svg)$/i, '.webp')}`,
    ];
  }
  // /assets/ 절대 경로
  else if (imageSrc.startsWith('/assets/')) {
    absolutePath = `/src${imageSrc}`;
    fallbackPaths = [
      `/src${imageSrc.replace(/\.(jpg|jpeg|png|gif|svg)$/i, '.webp')}`,
    ];
  }

  // 메인 경로와 폴백 경로들을 순서대로 시도
  const pathsToTry = [absolutePath, ...fallbackPaths].filter(Boolean);
  
  console.log(`🔍 이미지 감지 시도: ${imageSrc}`);
  console.log(`📁 현재 슬러그: ${finalSlug}`);
  console.log(`🎯 시도할 경로들:`, pathsToTry.slice(0, 3)); // 처음 3개만 로그
  
  for (const pathToTry of pathsToTry) {
    if (images[pathToTry]) {
      try {
        processedImageSrc = images[pathToTry]();
        useAstroImage = true;
        console.log(`✅ Astro Image 사용 성공: ${pathToTry}`);
        break;
      } catch (error) {
        console.warn(`⚠️ 이미지 import 실패: ${pathToTry}`, error);
        continue;
      }
    }
  }

  // 모든 경로에서 실패한 경우 디버깅 정보 출력
  if (!useAstroImage && absolutePath) {
    console.log(`❌ 이미지를 찾을 수 없음: ${imageSrc}`);
    console.log(`📂 사용 가능한 경로 샘플:`, Object.keys(images).filter(key => key.includes(finalSlug || '')).slice(0, 5));
  }
}

// 새로운 LQIP 시스템 사용 - 서버사이드에서 처리
const lqipInfo = await getLQIPInfo(imageSrc, finalSlug);
const { renderInfo, aspectRatio, hasData } = lqipInfo;

// 이미지 높이 계산 (aspectRatio가 있는 경우)
let calculatedHeight = height;
if (!height && aspectRatio !== 'auto') {
  const ratio = parseFloat(aspectRatio);
  if (!isNaN(ratio)) {
    calculatedHeight = Math.round(width / ratio);
  }
}

// LQIP 스타일 처리 - 서버사이드에서 완전히 렌더링
const lqipStyle = typeof renderInfo.style === 'string' 
  ? renderInfo.style 
  : Object.entries(renderInfo.style).map(([key, value]) => `${key}: ${value}`).join('; ');

// LCP 이미지에 대한 preload 힌트 생성 (첫 번째 이미지일 가능성이 높은 경우만)
const shouldPreload = useAstroImage && isLikelyFirstImage;
const preloadHref = shouldPreload ? (typeof processedImageSrc === 'string' ? processedImageSrc : '') : null;
---

<!-- LCP 이미지에 대한 preload 힌트 -->
{shouldPreload && preloadHref && (
  <link rel="preload" as="image" href={preloadHref} />
)}

<div
  class={`lqip-container ${full ? 'full-size' : 'compact-size'}`}
  style={`aspect-ratio: ${aspectRatio}; border-radius: 1rem; overflow: hidden; position: relative; ${
    full 
      ? 'width: 100%; margin: 1rem 0;' 
      : 'width: 80%; margin: 1.5rem auto; max-width: 640px;'
  }`}
  data-image-id={imageId}
  data-loading-state="loading"
>
  <!-- LQIP placeholder (서버사이드에서 완전히 렌더링) -->
  <div
    class={`lqip-placeholder ${renderInfo.className || ''}`}
    style={`${lqipStyle}; position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: opacity 0.6s cubic-bezier(0.4, 0.0, 0.2, 1); z-index: 1; opacity: 1;`}
    data-has-lqip={hasData}
  ></div>

  {useAstroImage ? 
    <Image
      id={imageId}
      src={processedImageSrc}
      alt={alt}
      width={width}
      height={calculatedHeight}
      widths={widths}
      sizes={sizes}
      quality={quality}
      format={format}
      loading={isLikelyFirstImage ? "eager" : "lazy"}
      style="width: 100%; height: auto; position: relative; z-index: 2; display: block; opacity: 0; transition: opacity 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);"
      {...(isLikelyFirstImage ? { fetchpriority: "high" } : {})}
      onload="this.style.opacity='1'; this.closest('.lqip-container').querySelector('.lqip-placeholder').style.opacity='0'; this.closest('.lqip-container').setAttribute('data-loading-state', 'loaded');"
      onerror="this.closest('.lqip-container').setAttribute('data-loading-state', 'error');"
    />
  : 
    <img
      id={imageId}
      src={imageSrc}
      alt={alt}
      loading={isLikelyFirstImage ? "eager" : "lazy"}
      style="width: 100%; height: auto; margin: 0; padding: 0; border: 0; display: block; position: relative; z-index: 2; opacity: 0; transition: opacity 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);"
      {...(isLikelyFirstImage ? { fetchpriority: "high" } : {})}
      onload="this.style.opacity='1'; this.closest('.lqip-container').querySelector('.lqip-placeholder').style.opacity='0'; this.closest('.lqip-container').setAttribute('data-loading-state', 'loaded');"
      onerror="this.closest('.lqip-container').setAttribute('data-loading-state', 'error');"
    />
  }

</div>

<!-- TBT 최적화: 클라이언트사이드 JavaScript 완전 제거, 인라인 이벤트 핸들러만 사용 -->

<style>
  /* LQIP 관련 스타일 */
  .lqip-container {
    position: relative;
    overflow: hidden;
  }
  
  /* 컴팩트 크기 (80%) - 기본값 */
  .compact-size {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .compact-size:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  }
  
  /* 풀사이즈 (100%) */
  .full-size {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }
  
  /* 반응형 조정 */
  @media (max-width: 768px) {
    .compact-size {
      width: 90% !important;
      max-width: none !important;
    }
    
    .full-size {
      margin: 1rem 0 !important;
    }
  }
  
  @media (max-width: 480px) {
    .compact-size {
      width: 95% !important;
      margin: 1rem auto !important;
    }
  }
  
  .lqip-placeholder {
    /* 부드러운 그라데이션 렌더링 */
    image-rendering: auto;
    /* 부드러운 fade out 효과 */
    transition: opacity 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
    opacity: 1;
  }
  
  .lqip-four-pixel {
    /* radial gradient 방식 특별 스타일 */
    filter: blur(0.5px);
    background-blend-mode: multiply;
  }
  
  .lqip-five-color {
    /* 5개 색상 방식 특별 스타일 */
    filter: blur(1px);
    background-blend-mode: soft-light;
    mix-blend-mode: multiply;
  }
  
  .lqip-fallback {
    /* 폴백 그라데이션 스타일 */
    opacity: 0.8;
  }
  
  /* 이미지 fade in 효과 */
  .lqip-container img {
    transition: opacity 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
    opacity: 0;
  }
  
  .lqip-container img[data-loaded="true"] {
    opacity: 1;
  }
  
  /* 로딩 상태별 스타일 */
  .lqip-container[data-loading-state="loading"] .lqip-placeholder {
    opacity: 1;
  }
  
  .lqip-container[data-loading-state="loaded"] .lqip-placeholder {
    opacity: 0;
  }
  
  .lqip-container[data-loading-state="error"] .lqip-placeholder {
    opacity: 1;
    /* 에러 시 약간 다른 스타일 */
    filter: brightness(0.9) saturate(0.8);
  }
  
  /* 부드러운 교차 페이드 효과 */
  @media (prefers-reduced-motion: no-preference) {
    .lqip-placeholder {
      transition: opacity 0.8s cubic-bezier(0.25, 0.1, 0.25, 1);
    }
    
    .lqip-container img {
      transition: opacity 0.6s cubic-bezier(0.25, 0.1, 0.25, 1);
    }
  }
  
  /* 애니메이션 축소 모드 지원 */
  @media (prefers-reduced-motion: reduce) {
    .lqip-placeholder,
    .lqip-container img {
      transition: opacity 0.2s ease;
    }
  }
</style>
