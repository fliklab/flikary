---
import { getLQIPInfo } from '../utils/lqip/astro-lqip';
import type { ResponsiveImagesManifest } from '../utils/responsive-images';

// ë°˜ì‘í˜• ì´ë¯¸ì§€ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì•ˆì „ ë¡œë”© (Vercel í™˜ê²½ í˜¸í™˜)
let responsiveImagesManifest: ResponsiveImagesManifest = {};
try {
  const { loadResponsiveImagesManifest } = await import('../utils/responsive-images');
  responsiveImagesManifest = await loadResponsiveImagesManifest();
} catch (error) {
  console.warn('ë°˜ì‘í˜• ì´ë¯¸ì§€ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨, í´ë°± ëª¨ë“œë¡œ ì§„í–‰:', error);
}

export interface Props {
  src: string | { src: string; [key: string]: unknown };
  alt: string;
  slug?: string;
  width?: number;
  height?: number;
  widths?: number[];
  sizes?: string;
  quality?: number;
  format?: 'webp' | 'avif' | 'png' | 'jpg';
  full?: boolean; // í’€ì‚¬ì´ì¦ˆ í‘œì‹œ ì—¬ë¶€
}

const { 
  src, 
  alt, 
  width = 800, 
  height,
  // quality = 80,
  // format = 'webp',
  full = false // ê¸°ë³¸ê°’ì€ 80% í¬ê¸°
} = Astro.props;

// ê³ ìœ í•œ ì´ë¯¸ì§€ ID ìƒì„±
const imageId = `img-${Math.random().toString(36).substr(2, 9)}`;

// URLì—ì„œ slug ì¶”ì¶œ
const urlPath = Astro.url.pathname;
const slugMatch = urlPath.match(/\/blog\/([^/]+)/);
const detectedSlug = slugMatch ? slugMatch[1] : undefined;
const finalSlug = Astro.props.slug || detectedSlug;

// srcê°€ ê°ì²´ì¸ì§€ ë¬¸ìì—´ì¸ì§€ í™•ì¸í•˜ê³  ì ì ˆí•œ ê°’ ì¶”ì¶œ
const imageSrc = typeof src === "object" ? src.src : src;

// ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ì˜ ì²« ë²ˆì§¸ ì´ë¯¸ì§€ íŒë‹¨ (ê°„ë‹¨í•œ íœ´ë¦¬ìŠ¤í‹±)
const isBlogPost = urlPath.includes('/blog/') && !urlPath.endsWith('/blog/');
const isLikelyFirstImage = isBlogPost && (
  imageSrc.startsWith('./') || 
  imageSrc.includes('@assets/images/') ||
  imageSrc.includes('assets/images/')
);

// ê¸°ê¸°ë³„ ìµœì í™”ëœ ë°˜ì‘í˜• ì´ë¯¸ì§€ ì„¤ì • (ë” ì„¸ë°€í•œ í¬ê¸° ì¡°ì •)
const responsiveConfig = full ? {
  // í’€ì‚¬ì´ì¦ˆ (100%) - í° ì´ë¯¸ì§€ë“¤
  widths: [480, 768, 1024, 1280, 1536],
  sizes: "(max-width: 480px) 100vw, (max-width: 768px) 100vw, (max-width: 1024px) 1024px, 1280px",
  type: 'full'
} : {
  // ì»´íŒ©íŠ¸ í¬ê¸° (80%) - ì‘ì€ ì´ë¯¸ì§€ë“¤  
  widths: [320, 480, 640, 768, 960],
  sizes: "(max-width: 480px) 95vw, (max-width: 768px) 80vw, (max-width: 1024px) 640px, 640px",
  type: 'compact'
};

const { sizes, type } = responsiveConfig;

// ì§ì ‘ ìƒì„±í•œ ë°˜ì‘í˜• ì´ë¯¸ì§€ ì‚¬ìš© (Astro Image ì‹œìŠ¤í…œ ëŒ€ì‹ )
let optimizedImages: { src: string; width: number; size: number }[] = [];
let fallbackImageSrc: string = imageSrc;
let useOptimizedImages = false;

// ì´ë¯¸ì§€ íŒŒì¼ëª… ì¶”ì¶œ (ê²½ë¡œì—ì„œ)
const imageFileName = imageSrc.split('/').pop() || imageSrc;
const cleanFileName = imageFileName.replace('./', '');

// Astroê°€ ì²˜ë¦¬í•œ í•´ì‹œ ë¶™ì€ íŒŒì¼ëª…ì—ì„œ ì›ë³¸ íŒŒì¼ëª… ë³µì›
const restoreOriginalFileName = (filename: string) => {
  // Astro í•´ì‹œ íŒ¨í„´ë“¤:
  // 1. filename.hash_hash.ext (ì˜ˆ: blog-written-by-ai.7p_-XgL_.webp)
  // 2. filename.hash.ext (ì˜ˆ: ask-to-gpt.DjQr6XwQ.webp)
  
  // íŒ¨í„´ 1: ì–¸ë”ë°”ê°€ í¬í•¨ëœ í•´ì‹œ (hash_hash)
  const hashPatternWithUnderscore = /\.[a-zA-Z0-9_-]+_[a-zA-Z0-9_-]+(\.[a-zA-Z0-9]+)$/;
  
  // íŒ¨í„´ 2: ë‹¨ìˆœ í•´ì‹œ (8ì ì´ìƒì˜ ì•ŒíŒŒë²³+ìˆ«ì ì¡°í•©)
  const hashPatternSimple = /\.[a-zA-Z0-9]{8,}(\.[a-zA-Z0-9]+)$/;
  
  if (hashPatternWithUnderscore.test(filename)) {
    // ì–¸ë”ë°” í¬í•¨ íŒ¨í„´ ì œê±°
    const restored = filename.replace(hashPatternWithUnderscore, '$1');
    console.log(`ğŸ”„ í•´ì‹œ ì œê±° (íŒ¨í„´1): ${filename} â†’ ${restored}`);
    return restored;
  } else if (hashPatternSimple.test(filename)) {
    // ë‹¨ìˆœ í•´ì‹œ íŒ¨í„´ ì œê±°
    const restored = filename.replace(hashPatternSimple, '$1');
    console.log(`ğŸ”„ í•´ì‹œ ì œê±° (íŒ¨í„´2): ${filename} â†’ ${restored}`);
    return restored;
  }
  
  return filename;
};

const originalFileName = restoreOriginalFileName(cleanFileName);

console.log(`ğŸ” ì´ë¯¸ì§€ ê²€ìƒ‰: slug=${finalSlug}, fileName=${cleanFileName} â†’ ì›ë³¸: ${originalFileName}`);

if (finalSlug && responsiveImagesManifest[finalSlug] && responsiveImagesManifest[finalSlug][originalFileName]) {
  const imageData = responsiveImagesManifest[finalSlug][originalFileName];
  const responsiveData = imageData.responsive[type];
  
  console.log(`âœ… ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì—ì„œ ì´ë¯¸ì§€ ë°œê²¬: ${originalFileName}`);
  
  // WebP ìš°ì„ , ì—†ìœ¼ë©´ JPG ì‚¬ìš©
  const formatData = (type === 'compact' || type === 'full') && responsiveData[type]
    ? responsiveData[type].webp || responsiveData[type].jpg
    : undefined;
  
  if (formatData && formatData.length > 0) {
    optimizedImages = formatData.map((img: { path: string; width: number; size: number }) => ({
      src: img.path,
      width: img.width,
      size: img.size
    }));
    
    // í´ë°± ì´ë¯¸ì§€ (ê°€ì¥ í° ì‚¬ì´ì¦ˆ ë˜ëŠ” ì›í•˜ëŠ” í¬ê¸°ì— ê°€ì¥ ê°€ê¹Œìš´ ê²ƒ)
    const targetWidth = width || 800;
    const closestImage = formatData.reduce((prev: { width: number; path: string }, curr: { width: number; path: string }) => 
      Math.abs(curr.width - targetWidth) < Math.abs(prev.width - targetWidth) ? curr : prev
    );
    
    fallbackImageSrc = closestImage.path;
    useOptimizedImages = true;
    
    console.log(`ğŸ¯ ë°˜ì‘í˜• ì´ë¯¸ì§€ ì¤€ë¹„ ì™„ë£Œ: ${optimizedImages.length}ê°œ í¬ê¸°, í´ë°±: ${fallbackImageSrc}`);
  }
} else {
  console.log(`âš ï¸  ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì—ì„œ ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${finalSlug}/${originalFileName} (ì›ë³¸: ${cleanFileName})`);
}

// ìƒˆë¡œìš´ LQIP ì‹œìŠ¤í…œ ì‚¬ìš© - ì„œë²„ì‚¬ì´ë“œì—ì„œ ì²˜ë¦¬ (SSGì— ì™„ì „íˆ í¬í•¨)
const lqipInfo = await getLQIPInfo(imageSrc, finalSlug);
const { renderInfo, aspectRatio, hasData } = lqipInfo;

// ì´ë¯¸ì§€ ë†’ì´ ê³„ì‚° (aspectRatioê°€ ìˆëŠ” ê²½ìš°)
let calculatedHeight = height;
if (!height && aspectRatio !== 'auto') {
  const ratio = parseFloat(aspectRatio);
  if (!isNaN(ratio)) {
    calculatedHeight = Math.round(width / ratio);
  }
}

// LQIP ìŠ¤íƒ€ì¼ ì²˜ë¦¬ - ì„œë²„ì‚¬ì´ë“œì—ì„œ ì™„ì „íˆ ë Œë”ë§ (SSGì— í¬í•¨)
const lqipStyle = typeof renderInfo.style === 'string' 
  ? renderInfo.style 
  : Object.entries(renderInfo.style).map(([key, value]) => `${key}: ${value}`).join('; ');

// LCP ì´ë¯¸ì§€ì— ëŒ€í•œ ê³ ë„í™”ëœ preload íŒíŠ¸ ìƒì„±
const shouldPreload = useOptimizedImages && isLikelyFirstImage;
const preloadHref = shouldPreload && fallbackImageSrc ? fallbackImageSrc : null;

// ë°˜ì‘í˜• preloadë¥¼ ìœ„í•œ ì´ë¯¸ì§€ í¬ê¸°ë³„ srcset ìƒì„±
let preloadSrcset = '';
let preloadSizes = '';
if (shouldPreload && optimizedImages.length > 0) {
  preloadSrcset = optimizedImages.map(img => `${img.src} ${img.width}w`).join(', ');
  preloadSizes = sizes || '(max-width: 480px) 95vw, (max-width: 768px) 90vw, (max-width: 1024px) 80vw, 640px';
}
---

<!-- LCP ì´ë¯¸ì§€ì— ëŒ€í•œ ê³ ë„í™”ëœ preload íŒíŠ¸ (SSGì— í¬í•¨) -->
{shouldPreload && preloadHref && (
  <>
    {/* ê¸°ë³¸ preload */}
    <link rel="preload" as="image" href={preloadHref} />
    
    {/* ë°˜ì‘í˜• preload (srcset ì§€ì›í•˜ëŠ” ë¸Œë¼ìš°ì €ìš©) */}
    {preloadSrcset && (
      <link 
        rel="preload" 
        as="image" 
        href={preloadHref}
        imagesrcset={preloadSrcset}
        imagesizes={preloadSizes}
      />
    )}
    
    {/* DNS prefetch for image domain */}
    <link rel="dns-prefetch" href="//flikary-git-preview-0724-fliklabs-projects.vercel.app" />
  </>
)}

<div
  class={`lqip-container ${full ? 'full-size' : 'compact-size'}`}
  style={`aspect-ratio: ${aspectRatio}; border-radius: 1rem; overflow: hidden; position: relative; ${
    full 
      ? 'width: 100%; margin: 1rem 0;' 
      : 'width: 80%; margin: 1.5rem auto; max-width: 640px;'
  }`}
  data-image-id={imageId}
  data-loading-state="loading"
>
  <!-- LQIP placeholder (ì„œë²„ì‚¬ì´ë“œì—ì„œ ì™„ì „íˆ ë Œë”ë§, SSGì— í¬í•¨) -->
  <div
    class={`lqip-placeholder ${renderInfo.className || ''}`}
    style={`${lqipStyle}; position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: opacity 0.6s cubic-bezier(0.4, 0.0, 0.2, 1); z-index: 1; opacity: 1;`}
    data-has-lqip={hasData}
  ></div>

  {useOptimizedImages && (
    <img
      id={imageId}
      src={fallbackImageSrc}
      srcset={optimizedImages.map(img => `${img.src} ${img.width}w`).join(', ')}
      sizes={sizes}
      alt={alt}
      width={width}
      height={calculatedHeight}
      loading={isLikelyFirstImage ? "eager" : "lazy"}
      decoding="async"
      style="width: 100%; height: auto; position: relative; z-index: 2; opacity: 0; transition: opacity 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);"
      {...(isLikelyFirstImage ? { fetchpriority: "high" } : {})}
      onload="this.style.opacity='1'; this.closest('.lqip-container').querySelector('.lqip-placeholder').style.opacity='0'; this.closest('.lqip-container').setAttribute('data-loading-state', 'loaded');"
      onerror="this.closest('.lqip-container').setAttribute('data-loading-state', 'error');"
    />
  )}

  {!useOptimizedImages && (
    <img
      id={imageId}
      src={imageSrc}
      alt={alt}
      loading={isLikelyFirstImage ? "eager" : "lazy"}
      style="width: 100%; height: auto; margin: 0; padding: 0; border: 0; display: block; position: relative; z-index: 2; opacity: 0; transition: opacity 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);"
      {...(isLikelyFirstImage ? { fetchpriority: "high" } : {})}
      onload="this.style.opacity='1'; this.closest('.lqip-container').querySelector('.lqip-placeholder').style.opacity='0'; this.closest('.lqip-container').setAttribute('data-loading-state', 'loaded');"
      onerror="this.closest('.lqip-container').setAttribute('data-loading-state', 'error');"
    />
  )}

</div>

<!-- TBT ìµœì í™”: í´ë¼ì´ì–¸íŠ¸ì‚¬ì´ë“œ JavaScript ì™„ì „ ì œê±°, ì¸ë¼ì¸ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë§Œ ì‚¬ìš© -->

<style>
  /* LQIP ê´€ë ¨ ìŠ¤íƒ€ì¼ - CLS ìµœì í™” */
  .lqip-container {
    position: relative;
    overflow: hidden;
    /* CLS ë°©ì§€: ì •í™•í•œ ê³µê°„ ì‚¬ì „ ì˜ˆì•½ */
    contain: layout style paint;
    /* GPU ê°€ì† í™œì„±í™” */
    transform: translateZ(0);
    will-change: auto;
  }
  
  /* ì»´íŒ©íŠ¸ í¬ê¸° (80%) - ê¸°ë³¸ê°’ */
  .compact-size {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .compact-size:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  }
  
  /* í’€ì‚¬ì´ì¦ˆ (100%) */
  .full-size {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }
  
  /* ë°˜ì‘í˜• ì¡°ì • */
  @media (max-width: 768px) {
    .compact-size {
      width: 90% !important;
      max-width: none !important;
    }
    
    .full-size {
      margin: 1rem 0 !important;
    }
  }
  
  @media (max-width: 480px) {
    .compact-size {
      width: 95% !important;
      margin: 1rem auto !important;
    }
  }
  
  .lqip-placeholder {
    /* ë¶€ë“œëŸ¬ìš´ ê·¸ë¼ë°ì´ì…˜ ë Œë”ë§ */
    image-rendering: auto;
    /* ë¶€ë“œëŸ¬ìš´ fade out íš¨ê³¼ */
    transition: opacity 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
    opacity: 1;
  }
  
  .lqip-four-pixel {
    /* radial gradient ë°©ì‹ íŠ¹ë³„ ìŠ¤íƒ€ì¼ */
    filter: blur(0.5px);
    background-blend-mode: multiply;
  }
  
  .lqip-five-color {
    /* 5ê°œ ìƒ‰ìƒ ë°©ì‹ íŠ¹ë³„ ìŠ¤íƒ€ì¼ */
    filter: blur(1px);
    background-blend-mode: soft-light;
    mix-blend-mode: multiply;
  }
  
  .lqip-fallback {
    /* í´ë°± ê·¸ë¼ë°ì´ì…˜ ìŠ¤íƒ€ì¼ */
    opacity: 0.8;
  }
  
  /* ì´ë¯¸ì§€ fade in íš¨ê³¼ - ì„±ëŠ¥ ìµœì í™” */
  .lqip-container img {
    transition: opacity 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
    opacity: 0;
    /* CLS ë°©ì§€: ì´ë¯¸ì§€ í¬ê¸° ê³ ì • */
    width: 100%;
    height: auto;
    display: block;
    /* ìµœì í™”ëœ ì´ë¯¸ì§€ ë Œë”ë§ */
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
    /* ë””ì½”ë”© ìµœì í™” */
    content-visibility: auto;
  }
  
  .lqip-container img[data-loaded="true"] {
    opacity: 1;
  }
  
  /* Intersection Observer ìµœì í™” */
  .lqip-container:not([data-loading-state="loaded"]) img {
    /* ë¡œë”© ì¤‘ì¼ ë•Œ GPU ìµœì í™” ë¹„í™œì„±í™” */
    will-change: opacity;
  }
  
  .lqip-container[data-loading-state="loaded"] img {
    /* ë¡œë”© ì™„ë£Œ í›„ GPU ìµœì í™” ì •ë¦¬ */
    will-change: auto;
  }
  
  /* ë¡œë”© ìƒíƒœë³„ ìŠ¤íƒ€ì¼ */
  .lqip-container[data-loading-state="loading"] .lqip-placeholder {
    opacity: 1;
  }
  
  .lqip-container[data-loading-state="loaded"] .lqip-placeholder {
    opacity: 0;
  }
  
  .lqip-container[data-loading-state="error"] .lqip-placeholder {
    opacity: 1;
    /* ì—ëŸ¬ ì‹œ ì•½ê°„ ë‹¤ë¥¸ ìŠ¤íƒ€ì¼ */
    filter: brightness(0.9) saturate(0.8);
  }
  
  /* ë¶€ë“œëŸ¬ìš´ êµì°¨ í˜ì´ë“œ íš¨ê³¼ */
  @media (prefers-reduced-motion: no-preference) {
    .lqip-placeholder {
      transition: opacity 0.8s cubic-bezier(0.25, 0.1, 0.25, 1);
    }
    
    .lqip-container img {
      transition: opacity 0.6s cubic-bezier(0.25, 0.1, 0.25, 1);
    }
  }
  
  /* ì• ë‹ˆë©”ì´ì…˜ ì¶•ì†Œ ëª¨ë“œ ì§€ì› */
  @media (prefers-reduced-motion: reduce) {
    .lqip-placeholder,
    .lqip-container img {
      transition: opacity 0.2s ease;
    }
  }
</style>
