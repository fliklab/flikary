---
import Layout from "@layouts/Layout.astro";
import Header from "@components/layout/Header.astro";
import Footer from "@components/layout/Footer.astro";
import Tag from "@components/Tag.astro";
import Datetime from "@components/Datetime";
import type { CollectionEntry } from "astro:content";
import { slugifyStr } from "@utils/content/text";
import type {
  AdjacentPostSummary,
  PostLayoutProps,
} from "@utils/content/posts";
import ShareLinks from "@components/buttons/ShareLinks.astro";
import BlogImage from "@components/blog-image/BlogImage.astro";
import ChevronLeft from "@icons/navigation/ChevronLeft.astro";
import ChevronRight from "@icons/navigation/ChevronRight.astro";
import postInteractionsScriptUrl from "../_scripts/post-interactions.ts?url";

type BlogPost = CollectionEntry<"blog">;

export interface Props {
  post: BlogPost;
  layoutProps: PostLayoutProps;
  prevPost: AdjacentPostSummary | null;
  nextPost: AdjacentPostSummary | null;
}

const { post, layoutProps, prevPost, nextPost } = Astro.props;

const { title, pubDatetime, modDatetime, tags, editPost, description } = post.data;

const { Content } = await post.render();
---

<Layout {...layoutProps}>
  <Header />

  <main id="main-content" class="post-page">
    <div class="post-card">
      <!-- Post Header -->
      <header class="post-header">
        <h1 class="post-title">
          {title}
        </h1>
        <Datetime
          pubDatetime={pubDatetime}
          modDatetime={modDatetime}
          size="lg"
          className="post-datetime"
          editPost={editPost}
          postId={post.id}
        />
        {description && (
          <p class="post-description">{description}</p>
        )}
      </header>

      <!-- Post Content -->
      <article id="article" class="post-content prose">
        <Content 
          components={{
            img: BlogImage
          }}
        />
      </article>

      <!-- Tags -->
      <footer class="post-footer">
        <ul class="post-tags">
          {tags.map(tag => <Tag tag={slugifyStr(tag)} tagName={tag} />)}
        </ul>

        <div class="post-share">
          <ShareLinks />
        </div>
      </footer>
    </div>

    <!-- Previous/Next Post Navigation -->
    <nav class="post-nav" aria-label="Post navigation">
      {
        prevPost ? (
          <a
            href={`/blog/${prevPost.slug}`}
            class="post-nav-link post-nav-prev"
            aria-label={`Previous: ${prevPost.title}`}
          >
            <ChevronLeft class="post-nav-icon" />
            <span class="post-nav-title">{prevPost.title}</span>
          </a>
        ) : (
          <span class="post-nav-placeholder" />
        )
      }
      {
        nextPost ? (
          <a
            href={`/blog/${nextPost.slug}`}
            class="post-nav-link post-nav-next"
            aria-label={`Next: ${nextPost.title}`}
          >
            <span class="post-nav-title">{nextPost.title}</span>
            <ChevronRight class="post-nav-icon" />
          </a>
        ) : (
          <span class="post-nav-placeholder" />
        )
      }
    </nav>
  </main>
  <Footer />
</Layout>

<style>
  /* Post Page Layout */
  .post-page {
    @apply mx-auto w-full px-4 pb-12;
    max-width: min(92vw, 52rem);
  }

  /* Card Container */
  .post-card {
    position: relative;
    background: var(--glass-surface-strong);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-xl);
    backdrop-filter: blur(var(--glass-blur));
    -webkit-backdrop-filter: blur(var(--glass-blur));
    overflow: hidden;
    padding: clamp(2rem, 5vw, 3.5rem);
  }

  /* Post Header */
  .post-header {
    text-align: center;
    margin-bottom: 2.5rem;
    padding-bottom: 2rem;
    border-bottom: 1px dashed rgba(var(--color-border), 0.5);
  }

  .post-title {
    @apply text-2xl font-semibold text-skin-base;
    font-family: var(--font-display);
    line-height: 1.3;
    margin-bottom: 0.75rem;
    letter-spacing: -0.02em;
  }

  .post-header :global(.post-datetime) {
    justify-content: center;
    color: rgba(var(--color-text-base), 0.6);
    font-size: 0.9rem;
  }

  .post-description {
    @apply text-base text-skin-base/70;
    text-align: center;
    line-height: 1.65;
    margin-top: 1.25rem;
    max-width: 38rem;
    margin-left: auto;
    margin-right: auto;
  }

  /* Post Content */
  .post-content {
    @apply mx-auto max-w-none;
  }

  /* Post Footer */
  .post-footer {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px dashed rgba(var(--color-border), 0.5);
  }

  .post-tags {
    @apply flex flex-wrap gap-2 justify-start;
    margin-bottom: 1.5rem;
  }

  .post-share {
    @apply flex items-center justify-start;
  }

  /* Post Navigation */
  .post-nav {
    @apply flex items-stretch justify-between gap-4;
    margin-top: 2rem;
  }

  .post-nav-link {
    @apply flex max-w-[45%] items-center gap-2 rounded-2xl px-4 py-3;
    background: var(--glass-surface);
    border: 1px solid var(--glass-border);
    transition: all 200ms ease;
  }

  .post-nav-link:hover {
    background: var(--glass-surface-strong);
    transform: translateY(-2px);
  }

  .post-nav-prev {
    @apply text-left;
  }

  .post-nav-next {
    @apply ml-auto text-right;
  }

  .post-nav-icon {
    @apply h-5 w-5 flex-shrink-0 opacity-60;
  }

  .post-nav-title {
    @apply line-clamp-2 text-sm text-skin-base/85;
  }

  .post-nav-placeholder {
    @apply flex-1;
  }

  /* Responsive adjustments */
  @media (max-width: 640px) {
    .post-card {
      padding: clamp(1.5rem, 4vw, 2rem);
      border-radius: 1.5rem;
    }

    .post-title {
      @apply text-xl;
    }

    .post-nav {
      flex-direction: column;
      gap: 1rem;
    }

    .post-nav-link {
      max-width: 100%;
    }

    .post-nav-next {
      margin-left: 0;
    }
  }
</style>
<script type="module" src={postInteractionsScriptUrl} />
