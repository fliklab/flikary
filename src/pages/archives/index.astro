---
import { getCollection } from "astro:content";
import { ArticleCard } from "@shared/components/article-card";
import Footer from "@components/layout/Footer.astro";
import Header from "@components/layout/Header.astro";
import { SITE } from "@config";
import Layout from "@layouts/Layout.astro";
import Main from "@layouts/Main.astro";
import { getPostsByGroupCondition } from "@utils/content/text";

// Redirect to 404 page if `showArchives` config is false
if (!SITE.showArchives) {
  return Astro.redirect("/404");
}

const posts = (await getCollection("blog", ({ data }) => !data.draft));

const MonthMap: Record<string, string> = {
  "1": "January",
  "2": "February",
  "3": "March",
  "4": "April",
  "5": "May",
  "6": "June",
  "7": "July",
  "8": "August",
  "9": "September",
  "10": "October",
  "11": "November",
  "12": "December",
};
---

<Layout title={`Archives | ${SITE.title}`}>
  <Header activeNav="archives" />
  <Main pageTitle="Archives" pageDesc="지나와보니 보이는 발자국들">
    {
      Object.entries(
        getPostsByGroupCondition(posts, post =>
          post.data.pubDatetime.getFullYear()
        )
      )
        .sort(([yearA], [yearB]) => Number(yearB) - Number(yearA))
        .map(([year, yearGroup]) => (
          <div class="archive-year-group">
            <span class="text-2xl font-bold">{year}</span>
            <sup class="text-sm">{yearGroup.length}</sup>
            {Object.entries(
              getPostsByGroupCondition(
                yearGroup,
                post => post.data.pubDatetime.getMonth() + 1
              )
            )
              .sort(([monthA], [monthB]) => Number(monthB) - Number(monthA))
              .map(([month, monthGroup]) => (
                <div class="archive-month-group">
                  <div class="archive-month-label">
                    <span class="font-bold">{MonthMap[month]}</span>
                    <sup class="text-xs">{monthGroup.length}</sup>
                  </div>
                  <ul class="archive-article-list">
                    {monthGroup
                      .sort(
                        (a, b) =>
                          Math.floor(
                            new Date(b.data.pubDatetime).getTime() / 1000
                          ) -
                          Math.floor(
                            new Date(a.data.pubDatetime).getTime() / 1000
                          )
                      )
                      .map(({ data, slug }) => (
                        <ArticleCard href={`/blog/${slug}/`} frontmatter={data} />
                      ))}
                  </ul>
                </div>
              ))}
          </div>
        ))
    }
  </Main>

  <Footer />
</Layout>

<style>
  .archive-year-group {
    margin-bottom: 2rem;
  }

  .archive-month-group {
    display: flex;
    flex-direction: column;
    margin-top: 1.5rem;
  }

  @media (min-width: 640px) {
    .archive-month-group {
      flex-direction: row;
      gap: 1.5rem;
    }
  }

  .archive-month-label {
    min-width: 9rem;
    font-size: 1.125rem;
    margin-top: 1.5rem;
  }

  @media (min-width: 640px) {
    .archive-month-label {
      margin-top: 0;
      padding-top: 1.5rem;
    }
  }

  .archive-article-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    list-style: none;
    padding: 0;
    margin: 0;
    flex: 1;
  }
</style>
